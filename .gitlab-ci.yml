# Prevent duplicated pipeline by removing MR pipelines
#workflow:
#  rules:
#    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
#      when: never
#    - when: always
variables:
  GIT_STRATEGY: none
  GIT_SUBMODULE_STRATEGY: none
#Common to all stages
default:
  tags: # Use shell instead of submitting pipeline to slurm
    - shell
  before_script:
    # Load python version, compilers
    - source /stck/rmilani/GitLab_CI_envs/CoMMA_env_el7.sh  # Centos7
    #- source /stck/rmilani/GitLab_CI_envs/CoMMA_env.sh  # Centos8

stages:
    - init
    - build 
    - test
    - documentation

job:init:
    stage: init
    variables: # Do it manually beacause we do not have git-lfs and that will cause problem
        GIT_STRATEGY: none
        GIT_SUBMODULE_STRATEGY: none
    before_script:
        - module purge
        # Load git-lfs otherwise, cloning fails
        # - source /scratchm/sonics/dist/spiro_el8_spack.sh && module load git-lfs-3.1.2-gcc-8.3.1-3mp4krr # CentOS8
        - source /scratchm/sonics/prod/spacky_2022-05-30/spacky.sh && module load git-lfs-3.1.2-gcc-11.2.0-kg4euxm # Centos7
        # Load python version, compilers
        - source /stck/rmilani/GitLab_CI_envs/CoMMA_env_el7.sh
        - python3 -c "import gcovr" || python3 -m pip install --user gcovr
    only:
        changes:
            - CoMMA_lib/*.{cpp,h}
            - tests/**/*.{cpp,h}
            - .gitlab-ci.yml
    script: # Set a commun directory and make it available
        # See https://docs.gitlab.com/ee/ci/variables/#pass-an-environment-variable-to-another-job
        # Create it at the root dir, so that it is found
        - echo "CUSTOM_CI_DIR=$PWD/CoMMA" >> build.env
        - (cd CoMMA && git fetch) ||
          (git clone --depth 5 git@gitlab.onera.net:numerics/solver/comma.git CoMMA)
        - cd CoMMA # Necessary even if the first cd CoMMA_CI completed
        - git submodule update --init Catch2
        - git submodule update --init pybind11
        - git pull --rebase
    artifacts:
        reports:
            dotenv: ./build.env

CoMMA:
    stage: build
    needs: ['job:init']
    only:
        changes:
            - CoMMA_lib/*.{cpp,h}
            - tests/**/*.{cpp,h}
            - .gitlab-ci.yml
    script:
        - cd $CUSTOM_CI_DIR
        - mkdir -p build
        - cd build
        - cmake -DCODAFLAGS=On ..
        - make -j
    artifacts:
        expire_in: 1 month
        paths:
            # The path is taken from the initial directory, hence we specify the full path
            - $CUSTOM_CI_DIR/build
test_a:
    stage: test
    needs: ['job:init', CoMMA]
    only:
        changes:
            - CoMMA_lib/*.{cpp,h}
            - tests/**/*.{cpp,h}
            - .gitlab-ci.yml
    script:
        - cd $CUSTOM_CI_DIR
        - cd build
        - ./Comma_test -r junit > test_a.xml
        - python3 -m gcovr --xml-pretty --exclude '\.\./pybind11/' --exclude '\.\./Catch2/' --print-summary -o coverage.xml --root ..
    coverage: /^\s*lines:\s*\d+.\d+\%/
    artifacts:
        expire_in: 1 month
        reports:
            junit: $CUSTOM_CI_DIR/build/test_a.xml
            coverage_report:
                coverage_format: cobertura
                path: $CUSTOM_CI_DIR/build/coverage.xml
pages:
    stage: documentation
    needs: ['job:init'] #job:init is needed to get dotenv artifacts
    script:
        - export cur_dir=$PWD
        - cd $CUSTOM_CI_DIR
        - doxygen Documentation/Doxyfile
        - cp -r documentation/html/ ${cur_dir}/public/
    artifacts:
        expire_in: 1 month
        paths:
            - ./public
    #rules:
    #    - if: $CI_COMMIT_REF_NAME == $CI_DEFAULT_BRANCH
    only:
          changes:
            - CoMMA_lib/*.{cpp,h,md}
            - .gitlab-ci.yml






